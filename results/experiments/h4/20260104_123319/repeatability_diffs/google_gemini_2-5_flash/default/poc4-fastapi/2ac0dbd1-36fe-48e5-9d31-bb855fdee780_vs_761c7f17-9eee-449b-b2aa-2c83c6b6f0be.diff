--- 2ac0dbd1-36fe-48e5-9d31-bb855fdee780
+++ 761c7f17-9eee-449b-b2aa-2c83c6b6f0be
@@ -1,5 +1,4 @@
 @@FILE:Dockerfile::backend/analytics_service/Dockerfile
-
 FROM python:3.9-slim-buster
 
 WORKDIR /app
@@ -13,7 +12,6 @@
 
 CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
 @@FILE:Dockerfile::backend/notes_service/Dockerfile
-
 FROM python:3.9-slim-buster
 
 WORKDIR /app
@@ -27,7 +25,6 @@
 
 CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
 @@FILE:Dockerfile::backend/users_service/Dockerfile
-
 FROM python:3.9-slim-buster
 
 WORKDIR /app
@@ -41,8 +38,6 @@
 
 CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
 @@FILE:Dockerfile::frontend/Dockerfile
-
-# Stage 1: Build the React application
 FROM node:18-alpine as builder
 
 WORKDIR /app
@@ -53,23 +48,19 @@
 COPY . .
 RUN npm run build
 
-# Stage 2: Serve the application with Nginx
-FROM nginx:stable-alpine
+FROM nginx:alpine
 
 COPY --from=builder /app/dist /usr/share/nginx/html
-COPY nginx.conf /etc/nginx/nginx.conf
+COPY nginx.conf /etc/nginx/conf.d/default.conf
 
 EXPOSE 80
 
-CMD ["nginx", "-g", ""daemon off;""]
+CMD ["nginx", "-g", "daemon off;"]
 @@FILE:K8s::k8s/analytics-deployment.yaml
-
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: analytics-service
-  labels:
-    app: analytics-service
 spec:
   replicas: 1
   selector:
@@ -82,17 +73,18 @@
     spec:
       containers:
         - name: analytics-service
-          image: analytics
+          image: analytics-service
           imagePullPolicy: IfNotPresent
-          ports:
-            - containerPort: 8000
           env:
             - name: DATABASE_URL
-              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/analytics_db"
+              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/$(POSTGRES_DB)"
             - name: RABBITMQ_URL
               value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@rabbitmq:5672/"
             - name: JWT_SECRET
-              value: "your-secret-key-change-in-production"
+              valueFrom:
+                secretKeyRef:
+                  name: jwt-secret
+                  key: JWT_SECRET
             - name: POSTGRES_USER
               valueFrom:
                 secretKeyRef:
@@ -103,6 +95,11 @@
                 secretKeyRef:
                   name: postgres-secret
                   key: POSTGRES_PASSWORD
+            - name: POSTGRES_DB
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_DB
             - name: RABBITMQ_DEFAULT_USER
               valueFrom:
                 secretKeyRef:
@@ -113,25 +110,27 @@
                 secretKeyRef:
                   name: rabbitmq-secret
                   key: RABBITMQ_DEFAULT_PASS
-          resources:
-            requests:
-              cpu: "50m"
-              memory: "128Mi"
-            limits:
-              cpu: "200m"
-              memory: "256Mi"
+          ports:
+            - containerPort: 8000
           livenessProbe:
             httpGet:
               path: /health
               port: 8000
             initialDelaySeconds: 10
-            periodSeconds: 10
+            periodSeconds: 5
           readinessProbe:
             httpGet:
               path: /health
               port: 8000
-            initialDelaySeconds: 5
+            initialDelaySeconds: 10
             periodSeconds: 5
+          resources:
+            requests:
+              memory: "128Mi"
+              cpu: "100m"
+            limits:
+              memory: "256Mi"
+              cpu: "200m"
 @@FILE:K8s::k8s/analytics-service.yaml
 apiVersion: v1
 kind: Service
@@ -146,13 +145,10 @@
       targetPort: 8000
   type: ClusterIP
 @@FILE:K8s::k8s/frontend-deployment.yaml
-
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: frontend
-  labels:
-    app: frontend
 spec:
   replicas: 1
   selector:
@@ -171,13 +167,12 @@
             - containerPort: 80
           resources:
             requests:
+              memory: "64Mi"
               cpu: "50m"
+            limits:
               memory: "128Mi"
-            limits:
-              cpu: "200m"
-              memory: "256Mi"
+              cpu: "100m"
 @@FILE:K8s::k8s/frontend-service.yaml
-
 apiVersion: v1
 kind: Service
 metadata:
@@ -191,47 +186,38 @@
       targetPort: 80
   type: ClusterIP
 @@FILE:K8s::k8s/ingress.yaml
-
 apiVersion: networking.k8s.io/v1
 kind: Ingress
 metadata:
   name: poc4-fastapi-ingress
   annotations:
-    nginx.ingress.kubernetes.io/rewrite-target: /$2
-spec:
+    nginx.ingress.kubernetes.io/rewrite-target: /
+spec:
+  ingressClassName: nginx
   rules:
     - host: poc4-fastapi.rasztabiga.me
       http:
         paths:
-          - path: /api/notes(/|$)(.*)
-            pathType: Prefix
-            backend:
-              service:
-                name: notes-service
-                port:
-                  number: 8000
-          - path: /api/users(/|$)(.*)
-            pathType: Prefix
-            backend:
-              service:
-                name: users-service
-                port:
-                  number: 8000
-          - path: /(.*)
+          - path: /
             pathType: Prefix
             backend:
               service:
                 name: frontend
                 port:
                   number: 80
+@@FILE:K8s::k8s/jwt-secret.yaml
+apiVersion: v1
+kind: Secret
+metadata:
+  name: jwt-secret
+type: Opaque
+data:
+  JWT_SECRET: eW91ci1zZWNyZXQta2V5LWNoYW5nZS1pbi1wcm9kdWN0aW9u
 @@FILE:K8s::k8s/notes-deployment.yaml
-
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: notes-service
-  labels:
-    app: notes-service
 spec:
   replicas: 1
   selector:
@@ -244,17 +230,18 @@
     spec:
       containers:
         - name: notes-service
-          image: notes
+          image: notes-service
           imagePullPolicy: IfNotPresent
-          ports:
-            - containerPort: 8000
           env:
             - name: DATABASE_URL
-              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/notes_db"
+              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/$(POSTGRES_DB)"
             - name: RABBITMQ_URL
               value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@rabbitmq:5672/"
             - name: JWT_SECRET
-              value: "your-secret-key-change-in-production"
+              valueFrom:
+                secretKeyRef:
+                  name: jwt-secret
+                  key: JWT_SECRET
             - name: POSTGRES_USER
               valueFrom:
                 secretKeyRef:
@@ -265,6 +252,11 @@
                 secretKeyRef:
                   name: postgres-secret
                   key: POSTGRES_PASSWORD
+            - name: POSTGRES_DB
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_DB
             - name: RABBITMQ_DEFAULT_USER
               valueFrom:
                 secretKeyRef:
@@ -275,27 +267,28 @@
                 secretKeyRef:
                   name: rabbitmq-secret
                   key: RABBITMQ_DEFAULT_PASS
-          resources:
-            requests:
-              cpu: "50m"
-              memory: "128Mi"
-            limits:
-              cpu: "200m"
-              memory: "256Mi"
+          ports:
+            - containerPort: 8000
           livenessProbe:
             httpGet:
               path: /health
               port: 8000
             initialDelaySeconds: 10
-            periodSeconds: 10
+            periodSeconds: 5
           readinessProbe:
             httpGet:
               path: /health
               port: 8000
-            initialDelaySeconds: 5
+            initialDelaySeconds: 10
             periodSeconds: 5
+          resources:
+            requests:
+              memory: "128Mi"
+              cpu: "100m"
+            limits:
+              memory: "256Mi"
+              cpu: "200m"
 @@FILE:K8s::k8s/notes-service.yaml
-
 apiVersion: v1
 kind: Service
 metadata:
@@ -308,31 +301,17 @@
       port: 8000
       targetPort: 8000
   type: ClusterIP
-@@FILE:K8s::k8s/postgres-pvc.yaml
-
-apiVersion: v1
-kind: PersistentVolumeClaim
-metadata:
-  name: postgres-pvc
-spec:
-  accessModes:
-    - ReadWriteOnce
-  resources:
-    requests:
-      storage: 1Gi
-  storageClassName: microk8s-hostpath
 @@FILE:K8s::k8s/postgres-secret.yaml
-
 apiVersion: v1
 kind: Secret
 metadata:
   name: postgres-secret
 type: Opaque
 data:
-  POSTGRES_USER: cG9zdGdyZXNfdXNlcg==
-  POSTGRES_PASSWORD: cG9zdGdyZXNfcGFzc3dvcmQ=
+  POSTGRES_USER: cG9jNHVzZXI=
+  POSTGRES_PASSWORD: cG9jNHBhc3N3b3Jk
+  POSTGRES_DB: cG9jNGRi
 @@FILE:K8s::k8s/postgres-service.yaml
-
 apiVersion: v1
 kind: Service
 metadata:
@@ -365,57 +344,45 @@
         - name: postgres
           image: postgres:13
           imagePullPolicy: IfNotPresent
+          env:
+            - name: POSTGRES_DB
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_DB
+            - name: POSTGRES_USER
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_USER
+            - name: POSTGRES_PASSWORD
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_PASSWORD
           ports:
             - containerPort: 5432
               name: postgres
-          env:
-            - name: POSTGRES_USER
-              valueFrom:
-                secretKeyRef:
-                  name: postgres-secret
-                  key: POSTGRES_USER
-            - name: POSTGRES_PASSWORD
-              valueFrom:
-                secretKeyRef:
-                  name: postgres-secret
-                  key: POSTGRES_PASSWORD
-            - name: POSTGRES_DB
-              value: notes_db # Default database, other dbs will be created by the app
           volumeMounts:
-            - name: postgres-storage
+            - name: postgres-data
               mountPath: /var/lib/postgresql/data
           resources:
             requests:
-              cpu: "100m"
               memory: "256Mi"
+              cpu: "250m"
             limits:
+              memory: "512Mi"
               cpu: "500m"
-              memory: "512Mi"
   volumeClaimTemplates:
     - metadata:
-        name: postgres-storage
+        name: postgres-data
       spec:
-        accessModes:
-          - ReadWriteOnce
+        accessModes: ["ReadWriteOnce"]
+        storageClassName: "microk8s-hostpath"
         resources:
           requests:
             storage: 1Gi
-        storageClassName: microk8s-hostpath
-@@FILE:K8s::k8s/rabbitmq-pvc.yaml
-
-apiVersion: v1
-kind: PersistentVolumeClaim
-metadata:
-  name: rabbitmq-pvc
-spec:
-  accessModes:
-    - ReadWriteOnce
-  resources:
-    requests:
-      storage: 1Gi
-  storageClassName: microk8s-hostpath
 @@FILE:K8s::k8s/rabbitmq-secret.yaml
-
 apiVersion: v1
 kind: Secret
 metadata:
@@ -425,7 +392,6 @@
   RABBITMQ_DEFAULT_USER: cmFiYml0bXE=
   RABBITMQ_DEFAULT_PASS: cmFiYml0bXE=
 @@FILE:K8s::k8s/rabbitmq-service.yaml
-
 apiVersion: v1
 kind: Service
 metadata:
@@ -434,17 +400,16 @@
   selector:
     app: rabbitmq
   ports:
-    - protocol: TCP
+    - name: amqp
+      protocol: TCP
       port: 5672
       targetPort: 5672
-      name: amqp
-    - protocol: TCP
+    - name: management
+      protocol: TCP
       port: 15672
       targetPort: 15672
-      name: management
   type: ClusterIP
 @@FILE:K8s::k8s/rabbitmq-statefulset.yaml
-
 apiVersion: apps/v1
 kind: StatefulSet
 metadata:
@@ -462,52 +427,48 @@
     spec:
       containers:
         - name: rabbitmq
-          image: rabbitmq:3-management-alpine
+          image: rabbitmq:3-management
           imagePullPolicy: IfNotPresent
+          env:
+            - name: RABBITMQ_DEFAULT_USER
+              valueFrom:
+                secretKeyRef:
+                  name: rabbitmq-secret
+                  key: RABBITMQ_DEFAULT_USER
+            - name: RABBITMQ_DEFAULT_PASS
+              valueFrom:
+                secretKeyRef:
+                  name: rabbitmq-secret
+                  key: RABBITMQ_DEFAULT_PASS
           ports:
             - containerPort: 5672
               name: amqp
             - containerPort: 15672
               name: management
-          env:
-            - name: RABBITMQ_DEFAULT_USER
-              valueFrom:
-                secretKeyRef:
-                  name: rabbitmq-secret
-                  key: RABBITMQ_DEFAULT_USER
-            - name: RABBITMQ_DEFAULT_PASS
-              valueFrom:
-                secretKeyRef:
-                  name: rabbitmq-secret
-                  key: RABBITMQ_DEFAULT_PASS
           volumeMounts:
-            - name: rabbitmq-storage
+            - name: rabbitmq-data
               mountPath: /var/lib/rabbitmq
           resources:
             requests:
-              cpu: "100m"
               memory: "256Mi"
+              cpu: "250m"
             limits:
+              memory: "512Mi"
               cpu: "500m"
-              memory: "512Mi"
   volumeClaimTemplates:
     - metadata:
-        name: rabbitmq-storage
+        name: rabbitmq-data
       spec:
-        accessModes:
-          - ReadWriteOnce
+        accessModes: ["ReadWriteOnce"]
+        storageClassName: "microk8s-hostpath"
         resources:
           requests:
             storage: 1Gi
-        storageClassName: microk8s-hostpath
 @@FILE:K8s::k8s/users-deployment.yaml
-
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: users-service
-  labels:
-    app: users-service
 spec:
   replicas: 1
   selector:
@@ -520,17 +481,18 @@
     spec:
       containers:
         - name: users-service
-          image: users
+          image: users-service
           imagePullPolicy: IfNotPresent
-          ports:
-            - containerPort: 8000
           env:
             - name: DATABASE_URL
-              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/users_db"
+              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/$(POSTGRES_DB)"
             - name: RABBITMQ_URL
               value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@rabbitmq:5672/"
             - name: JWT_SECRET
-              value: "your-secret-key-change-in-production"
+              valueFrom:
+                secretKeyRef:
+                  name: jwt-secret
+                  key: JWT_SECRET
             - name: POSTGRES_USER
               valueFrom:
                 secretKeyRef:
@@ -541,6 +503,11 @@
                 secretKeyRef:
                   name: postgres-secret
                   key: POSTGRES_PASSWORD
+            - name: POSTGRES_DB
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_DB
             - name: RABBITMQ_DEFAULT_USER
               valueFrom:
                 secretKeyRef:
@@ -551,25 +518,27 @@
                 secretKeyRef:
                   name: rabbitmq-secret
                   key: RABBITMQ_DEFAULT_PASS
-          resources:
-            requests:
-              cpu: "50m"
-              memory: "128Mi"
-            limits:
-              cpu: "200m"
-              memory: "256Mi"
+          ports:
+            - containerPort: 8000
           livenessProbe:
             httpGet:
               path: /health
               port: 8000
             initialDelaySeconds: 10
-            periodSeconds: 10
+            periodSeconds: 5
           readinessProbe:
             httpGet:
               path: /health
               port: 8000
-            initialDelaySeconds: 5
+            initialDelaySeconds: 10
             periodSeconds: 5
+          resources:
+            requests:
+              memory: "128Mi"
+              cpu: "100m"
+            limits:
+              memory: "256Mi"
+              cpu: "200m"
 @@FILE:K8s::k8s/users-service.yaml
 apiVersion: v1
 kind: Service