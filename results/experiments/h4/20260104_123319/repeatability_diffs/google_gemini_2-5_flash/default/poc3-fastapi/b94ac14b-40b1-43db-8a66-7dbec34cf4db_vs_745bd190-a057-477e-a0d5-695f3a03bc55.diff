--- b94ac14b-40b1-43db-8a66-7dbec34cf4db
+++ 745bd190-a057-477e-a0d5-695f3a03bc55
@@ -1,5 +1,5 @@
 @@FILE:Dockerfile::backend/Dockerfile
-FROM python:3.10-slim-buster
+FROM python:3.9-slim-buster
 
 WORKDIR /app
 
@@ -12,20 +12,20 @@
 
 CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
 @@FILE:Dockerfile::frontend/Dockerfile
-FROM node:20-alpine AS builder
+FROM node:16-alpine as build-stage
 
 WORKDIR /app
 
-COPY package.json package-lock.json ./
+COPY package*.json ./
 RUN npm install
 
 COPY . .
 RUN npm run build
 
-FROM nginx:stable-alpine
-
-COPY nginx.conf /etc/nginx/nginx.conf
-COPY --from=builder /app/dist /usr/share/nginx/html
+FROM nginx:stable-alpine as production-stage
+
+COPY nginx.conf /etc/nginx/conf.d/default.conf
+COPY --from=build-stage /app/dist /usr/share/nginx/html
 
 EXPOSE 80
 
@@ -53,27 +53,42 @@
             - containerPort: 8000
           env:
             - name: DATABASE_URL
-              value: postgresql://poc3-fastapi:poc3_password@postgres:5432/poc3-fastapi
-          livenessProbe:
-            httpGet:
-              path: /
-              port: 8000
-            initialDelaySeconds: 10
-            periodSeconds: 10
-          readinessProbe:
-            httpGet:
-              path: /
-              port: 8000
-            initialDelaySeconds: 5
-            periodSeconds: 5
+              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgres:5432/$(POSTGRES_DB)"
+            - name: POSTGRES_USER
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_USER
+            - name: POSTGRES_PASSWORD
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_PASSWORD
+            - name: POSTGRES_DB
+              valueFrom:
+                secretKeyRef:
+                  name: postgres-secret
+                  key: POSTGRES_DB
           resources:
             requests:
+              memory: "128Mi"
               cpu: "100m"
-              memory: "128Mi"
             limits:
-              cpu: "500m"
-              memory: "512Mi"
-@@FILE:K8s::k8s/backend-service.yaml
+              memory: "256Mi"
+              cpu: "200m"
+          livenessProbe:
+            httpGet:
+              path: /
+              port: 8000
+            initialDelaySeconds: 5
+            periodSeconds: 5
+          readinessProbe:
+            httpGet:
+              path: /
+              port: 8000
+            initialDelaySeconds: 5
+            periodSeconds: 5
+---
 apiVersion: v1
 kind: Service
 metadata:
@@ -85,7 +100,6 @@
     - protocol: TCP
       port: 8000
       targetPort: 8000
-  type: ClusterIP
 @@FILE:K8s::k8s/frontend-deployment.yaml
 apiVersion: apps/v1
 kind: Deployment
@@ -109,12 +123,24 @@
             - containerPort: 80
           resources:
             requests:
+              memory: "64Mi"
               cpu: "50m"
-              memory: "64Mi"
             limits:
-              cpu: "200m"
-              memory: "256Mi"
-@@FILE:K8s::k8s/frontend-service.yaml
+              memory: "128Mi"
+              cpu: "100m"
+          livenessProbe:
+            httpGet:
+              path: /
+              port: 80
+            initialDelaySeconds: 5
+            periodSeconds: 5
+          readinessProbe:
+            httpGet:
+              path: /
+              port: 80
+            initialDelaySeconds: 5
+            periodSeconds: 5
+---
 apiVersion: v1
 kind: Service
 metadata:
@@ -126,7 +152,6 @@
     - protocol: TCP
       port: 80
       targetPort: 80
-  type: ClusterIP
 @@FILE:K8s::k8s/ingress.yaml
 apiVersion: networking.k8s.io/v1
 kind: Ingress
@@ -135,10 +160,18 @@
   annotations:
     nginx.ingress.kubernetes.io/rewrite-target: /$2
 spec:
+  ingressClassName: nginx
   rules:
     - host: poc3-fastapi.rasztabiga.me
       http:
         paths:
+          - path: /
+            pathType: Prefix
+            backend:
+              service:
+                name: frontend
+                port:
+                  number: 80
           - path: /api(/|$)(.*)
             pathType: Prefix
             backend:
@@ -146,13 +179,6 @@
                 name: backend
                 port:
                   number: 8000
-          - path: /(.*)
-            pathType: Prefix
-            backend:
-              service:
-                name: frontend
-                port:
-                  number: 80
 @@FILE:K8s::k8s/postgres-secret.yaml
 apiVersion: v1
 kind: Secret
@@ -160,22 +186,9 @@
   name: postgres-secret
 type: Opaque
 data:
-  POSTGRES_DB: cG9jMy1mYXN0YXBp
-  POSTGRES_USER: cG9jMy1mYXN0YXBp
-  POSTGRES_PASSWORD: cG9jM19wYXNzd29yZA==
-@@FILE:K8s::k8s/postgres-service.yaml
-apiVersion: v1
-kind: Service
-metadata:
-  name: postgres
-spec:
-  selector:
-    app: postgres
-  ports:
-    - protocol: TCP
-      port: 5432
-      targetPort: 5432
-  type: ClusterIP
+  POSTGRES_USER: cG9zdGdyZXN1c2Vy
+  POSTGRES_PASSWORD: cG9zdGdyZXNwYXNzd29yZA==
+  POSTGRES_DB: bm90ZXNkYg==
 @@FILE:K8s::k8s/postgres-statefulset.yaml
 apiVersion: apps/v1
 kind: StatefulSet
@@ -205,11 +218,11 @@
               mountPath: /var/lib/postgresql/data
           resources:
             requests:
-              cpu: "100m"
               memory: "256Mi"
+              cpu: "250m"
             limits:
+              memory: "512Mi"
               cpu: "500m"
-              memory: "512Mi"
   volumeClaimTemplates:
     - metadata:
         name: postgres-data
@@ -218,3 +231,15 @@
         resources:
           requests:
             storage: 1Gi
+---
+apiVersion: v1
+kind: Service
+metadata:
+  name: postgres
+spec:
+  selector:
+    app: postgres
+  ports:
+    - protocol: TCP
+      port: 5432
+      targetPort: 5432